var t=Object.defineProperty,e=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,s=(e,n,r)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r;import{r as o,R as i,a as c}from"./vendor.2786b42d.js";class a{constructor(t){this.id=t,this.Data=void 0}create(t){return{component:this,data:t}}serialize(t){return JSON.stringify(t)}deserialize(t){return this.validate(JSON.parse(t))}}class l extends a{constructor(t,e){super(t),this.getter=e}create(){const t=this;return{component:this,get data(){return t.getter()}}}injectGlobal(t){this.getter=t}serialize(t){return"null"}validate(t){return this.getter()}}const u=class extends a{constructor(){super("Number")}validate(t){if("number"==typeof t)return t;throw new Error(`Expected Number but ${t} received.`)}};let p=u;function d(){return p.INSTANCE}p.INSTANCE=new u;const m=class extends a{constructor(){super("String")}validate(t){if("string"==typeof t)return t;throw new Error(`Expected String but ${t} received.`)}};m.INSTANCE=new m;const h=class extends a{constructor(){super("Boolean")}validate(t){if("boolean"==typeof t)return t;throw new Error(`Expected Boolean but ${t} received.`)}};h.INSTANCE=new h;class y extends a{constructor(t,e){super(t),this.schema=e}validate(t){if("object"!=typeof t||!t)throw new Error(`Expected Array but ${t} received.`);const o={},i=((t,o)=>{for(var i in o||(o={}))n.call(o,i)&&s(t,i,o[i]);if(e)for(var i of e(o))r.call(o,i)&&s(t,i,o[i]);return t})({},this.schema);for(const e of Object.keys(t)){if(!(e in i))throw new Error(`Unexpected key ${e}`);o[e]=i[e].validate(t[e]),delete i[e]}const c=Object.keys(i);if(c.length>0)throw new Error(`Expected ${c.join(", ")}, but neither accepted.`);return o}}function f(t,e){return new y(t,e)}const E=f("Position",{x:d(),y:d()}),v=f("Velocity",{x:d(),y:d()});function b(t,e){return new class extends class{constructor(t){this.componentArray=t}runNow(t){for(const e of Object.values(t.entities)){const n=this.componentArray.map((n=>t.getEntityData(e,n)));n.every((t=>t))&&this.run(n)}}}{constructor(){super(t)}setup(){}run(t){e(...t)}dispose(){}}}function w(){return Math.min(window.innerWidth,window.innerHeight)}function g(t,e,n){return t<e?e:n<t?n:t}const x=b([E,v],((t,e)=>{t.x=g(t.x+e.x,0,w()-48),t.y=g(t.y+e.y,0,w()-48-320)}));function O(t,e){const n=t+-Math.sign(t)*e;return Math.sign(t)!=Math.sign(n)?0:n}const j=b([v],(t=>{t.x=O(t.x,4),t.y=O(t.y,4)})),S=b([E,v],((t,e)=>{e.y+=4*Math.atan((w()-48-320-t.y)/4)}));class I{constructor(t){this.id=t}}class N{constructor(t){this.lastEntityId=0,this.entities={},this.components={},this.componentsRegistered={};for(const e of t)this.componentsRegistered[e.id]=e}createEntity(t){const e=new I(this.lastEntityId.toString());this.lastEntityId+=1;for(const n of t)n.component.id in this.components||(this.components[n.component.id]={}),this.components[n.component.id][e.id]=n.data;return this.entities[e.id]=e,e}getEntityData(t,e){var n;return null==(n=this.components[e.id])?void 0:n[t.id]}loadSnapshot(t){const e=JSON.parse(t);this.lastEntityId=e.lastEntityId,this.entities=Object.fromEntries(e.entities.map((t=>[t,new I(t)]))),console.log(e.components),this.components=Object.fromEntries(Object.entries(e.components).map((([t,e])=>[t,Object.fromEntries(Object.entries(e).map((([e,n])=>[e,this.componentsRegistered[t].deserialize(String(n))])))])))}createSnapshot(){return JSON.stringify({lastEntityId:this.lastEntityId,entities:Object.keys(this.entities),components:Object.fromEntries(Object.entries(this.components).map((([t,e])=>[t,Object.fromEntries(Object.entries(e).map((([e,n])=>[e,this.componentsRegistered[t].serialize(n)])))])))})}}class k{constructor(t){this.systems=t}setup(t){for(const e of this.systems)e.setup(t)}dispatch(t){for(const e of this.systems)e.runNow(t)}}const D=(R={moveUp:!1,moveLeft:!1,moveDown:!1,moveRight:!1},new l("Input",(()=>R)));var R;const A=b([D,E,v],((t,e,n)=>{t.moveUp&&w()-48-320-e.y<1&&(n.y=-40),t.moveLeft&&(n.x=-20),t.moveRight&&(n.x=20)}));function U(){const t=function(t,e){const[n]=o.exports.useState(new N(t));return o.exports.useEffect((()=>{const t=null==e?void 0:e(n);t&&n.loadSnapshot(t)}),[]),n}([D,E,v],(t=>{const e=localStorage.getItem("world");return e||(t.createEntity([D.create(),E.create({x:0,y:0}),v.create({x:0,y:0})]),null)})),e=function(t,e){const[n]=o.exports.useState(new k(e)),[r,s]=o.exports.useState(0);return o.exports.useEffect((()=>{n.setup(t)}),[n]),{dispatch(){n.dispatch(t),s((t=>t+1))}}}(t,[x,j,S,A]),{keypress:n,handleKeyDown:r,handleKeyUp:s}=function(t){const e=o.exports.useRef(Object.fromEntries(Object.values(t).map((t=>[t,!1])))),n=o.exports.useCallback((n=>{const r=t[n.key];r&&(e.current[r]=!0)}),[]),r=o.exports.useCallback((n=>{const r=t[n.key];r&&(e.current[r]=!1)}),[]);return{keypress:e,handleKeyDown:n,handleKeyUp:r}}({w:"moveUp",a:"moveLeft",s:"moveDown",d:"moveRight"});var c,a,l;return D.injectGlobal((()=>n.current)),c=60,a=()=>{e.dispatch(),localStorage.setItem("world",t.createSnapshot())},l=[e],o.exports.useEffect((()=>{const t=setInterval((()=>{a()}),1e3/c);return()=>clearInterval(t)}),l),i.createElement("div",{className:"App",tabIndex:0,onKeyDown:r,onKeyUp:s},Object.values(t.entities).map((e=>{const n=t.getEntityData(e,E);return n?i.createElement("div",{className:"me",key:e.id,style:{left:n.x,top:n.y}}):null})),i.createElement("div",{className:"ground"}," "))}c.render(i.createElement(i.StrictMode,null,i.createElement(U,null)),document.getElementById("root"));
